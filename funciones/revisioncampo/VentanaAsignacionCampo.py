# -*- coding: utf-8 -*-
"""
/***************************************************************************
 VentanaAsignacionCampo
                                 A QGIS plugin
 VentanaAsignacionCampo
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2018-06-21
        git sha              : $Format:%H$
        copyright            : (C) 2018 by VentanaAsignacionCampo
        email                : VentanaAsignacionCampo
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""
from PyQt5.QtCore import QSettings, QTranslator, qVersion, QCoreApplication
from PyQt5.QtGui import QIcon
from PyQt5.QtWidgets import QAction, QMessageBox
from PyQt5 import QtCore
from PyQt5 import QtWidgets
# Initialize Qt resources from file resources.py

# Import the code for the dialog
from .VentanaAsignacionCampo_dialog import VentanaAsignacionCampoDialog
import os.path
from qgis.utils import *
import os.path
import os, json, requests
from osgeo import ogr, osr

class VentanaAsignacionCampo:
    """QGIS Plugin Implementation."""

    def __init__(self, iface, pluginM):
        
        # Save reference to the QGIS interface
        self.iface = iface
        self.pluginM = pluginM
        # Create the dialog (after translation) and keep reference
        self.indexSel = []
        self.dlg = VentanaAsignacionCampoDialog()
        #self.dlg.setWindowFlags(QtCore.Qt.WindowStaysOnTopHint)

        self.dlg.btnLiberar.clicked.connect(self.preguntarLiberar)
        self.dlg.tablaMazPred.hideColumn(0)
        self.dlg.chkTodo.stateChanged.connect(self.marcarTodoMazPred)
        self.dlg.tablaMazPred.setEditTriggers(QtWidgets.QTableWidget.NoEditTriggers)
        self.dlg.fldUsuario.setReadOnly(True)

    def run(self):
        """Run method that performs all the real work"""
        # show the dialog
        
        #try:
        #    print('indice', indiceUsuario)
        #    cveUsuario = self.pluginM.enviosUsuario[indiceUsuario]
        #    print('cveusuao', cveUsuario)
        #except:
        #    self.pluginM.UTI.mostrarAlerta('El Usuario no existe', QMessageBox().Critical, "Asignacion de campo")
        #    return
        
        self.dlg.show()
        #self.pluginM.UTI.strechtTabla(self.dlg.tablaMazPred)
        self.traerAsignaciones()
        # Run the dialog event loop
        #result = self.dlg.exec_()
        # See if OK was pressed
        #if result:
            # Do something useful here - delete the line containing pass and
            # substitute with your code.
        #    pass

#--------------------------------------------------------------------------------------------------

    def traerAsignaciones(self):

        indiceUsuario = self.pluginM.dlg.cmbUsuario.currentIndex()

        cveUsuario = self.pluginM.enviosUsuario[indiceUsuario]
        
        nombreCompleto = self.pluginM.dlg.cmbUsuario.itemText(indiceUsuario)
        self.dlg.fldUsuario.setText(nombreCompleto)

        try:
            headers = {'Content-Type': 'application/json', 'Authorization' : self.pluginM.UTI.obtenerToken()}
            respuesta = requests.get(self.pluginM.CFG.urlAsigCampoConsultar + cveUsuario, headers = headers)

            if respuesta.status_code == 200:
                
                datos = respuesta.json()
                self.pluginM.vaciarTabla(self.dlg.tablaMazPred)
                for x in range(0, len(datos)):
                    self.dlg.tablaMazPred.insertRow(x)
                    dato = datos[x]
                    cveManzana = dato['cveManzana']
                    cveManzanaCorta = cveManzana[-3:]
                    cveCatastral = dato['cveCatastral']
                    cvePredio = cveCatastral[-2:] if len(cveCatastral) == 10 else cveCatastral[-5:]
                    item = QtWidgets.QTableWidgetItem(str(cveManzana))
                    self.dlg.tablaMazPred.setItem(x, 0 , item)

                    item = QtWidgets.QTableWidgetItem(str(cveManzanaCorta))
                    item.setFlags( QtCore.Qt.ItemIsUserCheckable |  QtCore.Qt.ItemIsEnabled )
                    item.setCheckState(QtCore.Qt.Unchecked)
                    self.dlg.tablaMazPred.setItem(x, 1 , item)

                    item = QtWidgets.QTableWidgetItem(str(cvePredio))
                    self.dlg.tablaMazPred.setItem(x, 2 , item)
                
            else:
                self.pluginM.UTI.mostrarAlerta(str(respuesta), QMessageBox().Critical, "Asignacion de campo")

        except requests.exceptions.RequestException:
            self.pluginM.UTI.mostrarAlerta(str(respuesta), QMessageBox().Critical, "Asignacion de campo")

#--------------------------------------------------------------------------------------------------------

    def preguntarLiberar(self):
        
        self.indexSel = []
        for c in range(0, self.dlg.tablaMazPred.rowCount()):
            if self.dlg.tablaMazPred.item(c, 1).checkState() == QtCore.Qt.Checked:
                self.indexSel.append(c)

        if len(self.indexSel) > 0:
            #self.dlg.setWindowFlags(self.dlg.windowFlags() & ~QtCore.Qt.WindowStaysOnTopHint)
            mensaje = "Desear liberar las asignaciones seleccionadas?"
            
            self.dlg.close()
            respuesta = QMessageBox().question(iface.mainWindow(), "Liberar asignaciones", mensaje, QMessageBox.Yes, QMessageBox.No)
            
            if respuesta == QMessageBox.Yes:
                self.liberarAsignaciones()

            else:
                self.dlg.show()
                self.traerAsignaciones()
            
        else:
            self.pluginM.UTI.mostrarAlerta("No has seleccionado ninguna asignacion a liberar", QMessageBox().Information, 'Liberar asignaciones')


#----------------------------------------------------------------------------------------------------------

    def liberarAsignaciones(self):

        listaEliminar = []
        
        for ix in self.indexSel:
            cveManzana = str(self.dlg.tablaMazPred.item(ix, 0).text())
            cvePredio = str(self.dlg.tablaMazPred.item(ix, 2).text())
            cveCatastral = cveManzana + cvePredio

            objeto = {}
            objeto['cveManzana'] = cveManzana
            objeto['cveCatastral'] = cveCatastral

            listaEliminar.append(objeto)

        listaEliminar = json.dumps(listaEliminar)

        try:
            headers = {'Content-Type': 'application/json', 'Authorization' : self.pluginM.UTI.obtenerToken()}
            respuesta = requests.post(self.pluginM.CFG.urlAsigCampoEliminar, headers = headers, data = listaEliminar)

            if respuesta.status_code == 200:
                
                self.pluginM.UTI.mostrarAlerta("Desasignacion completa", QMessageBox().Information, "Liberar asignaciones")
                self.dlg.close()
                self.pluginM.llenadoDeTablas()

            else:
                print(respuesta)
                self.pluginM.UTI.mostrarAlerta("Error de servidor v1", QMessageBox().Critical, "Liberar asignaciones")

        except requests.exceptions.RequestException:
            self.pluginM.UTI.mostrarAlerta("Error de servidor v2", QMessageBox().Critical, "Liberar asignaciones")
        
#-----------------------------------------------------------------------------------------

    def marcarTodoMazPred(self):
        if self.dlg.chkTodo.checkState() == QtCore.Qt.Checked:
            if self.dlg.tablaMazPred.rowCount() > 0:
                for c in range(0, self.dlg.tablaMazPred.rowCount()):
                    self.dlg.tablaMazPred.item(c, 1 ).setCheckState(QtCore.Qt.Checked)
            else:
                self.dlg.chkTodo.setCheckState(QtCore.Qt.Unchecked)
        else:
            for c in range(0, self.dlg.tablaMazPred.rowCount()):
                self.dlg.tablaMazPred.item(c, 1 ).setCheckState(QtCore.Qt.Unchecked)     